function keybind(value){let key={};key.value=value,key.isDown=!1,key.isUp=!0,key.press=void 0,key.release=void 0,key.downHandler=event=>{event.key===key.value&&(key.isUp&&key.press&&key.press(event),key.isDown=!0,key.isUp=!1,event.preventDefault())},key.upHandler=event=>{event.key===key.value&&(key.isDown&&key.release&&key.release(event),key.isDown=!1,key.isUp=!0,event.preventDefault())};const downListener=key.downHandler.bind(key),upListener=key.upHandler.bind(key);return window.addEventListener("keydown",downListener,!1),window.addEventListener("keyup",upListener,!1),key.unsubscribe=()=>{window.removeEventListener("keydown",downListener),window.removeEventListener("keyup",upListener)},key}function round(number,step){return Math.floor(number/step)*step}function remap(number,from,to){return to[0]+(number-from[0])*(to[1]-to[0])/(from[1]-from[0])}function isMobile(){var check=!1,a;return a=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))&&(check=!0),check}Array.prototype.last||(Array.prototype.last=function(){return this[this.length-1]}),Array.prototype.removeFrom||(Array.prototype.removeFrom=function(p){return this.splice(p,1)});const KEY_TYPES=["leftkey","blackkey","midkey","blackkey","rightkey","leftkey","blackkey","midkey","blackkey","midkey","blackkey","rightkey","leftkey","blackkey","midkey","blackkey","rightkey","leftkey","blackkey","midkey","blackkey","midkey","blackkey","rightkey-logo","lastkey"],BUTTON_TYPE=["button-up.png","button-up-green.png","button-up-yellow.png","button-up-blue.png","button-down.png","button-down-green.png","button-down-yellow.png","button-down-blue.png"],SLIDER_RANGE=[21,41];function frequency(note){return NOTE_TO_FREQ[note]}const NOTE_TO_FREQ=new Float32Array([8.1757989156,8.661957218,9.1770239974,9.7227182413,10.3008611535,10.9133822323,11.5623257097,12.2498573744,12.9782717994,13.75,14.5676175474,15.4338531643,16.3515978313,17.3239144361,18.3540479948,19.4454364826,20.6017223071,21.8267644646,23.1246514195,24.4997147489,25.9565435987,27.5,29.1352350949,30.8677063285,32.7031956626,34.6478288721,36.7080959897,38.8908729653,41.2034446141,43.6535289291,46.249302839,48.9994294977,51.9130871975,55,58.2704701898,61.735412657,65.4063913251,69.2956577442,73.4161919794,77.7817459305,82.4068892282,87.3070578583,92.4986056779,97.9988589954,103.826174395,110,116.5409403795,123.470825314,130.8127826503,138.5913154884,146.8323839587,155.563491861,164.8137784564,174.6141157165,184.9972113558,195.9977179909,207.65234879,220,233.081880759,246.9416506281,261.6255653006,277.1826309769,293.6647679174,311.1269837221,329.6275569129,349.228231433,369.9944227116,391.9954359817,415.3046975799,440,466.1637615181,493.8833012561,523.2511306012,554.3652619537,587.3295358348,622.2539674442,659.2551138257,698.456462866,739.9888454233,783.9908719635,830.6093951599,880,932.3275230362,987.7666025122,1046.5022612024,1108.7305239075,1174.6590716696,1244.5079348883,1318.5102276515,1396.912925732,1479.9776908465,1567.981743927,1661.2187903198,1760,1864.6550460724,1975.5332050245,2093.0045224048,2217.461047815,2349.3181433393,2489.0158697766,2637.020455303,2793.825851464,2959.9553816931,3135.963487854,3322.4375806396,3520,3729.3100921447,3951.066410049,4186.0090448096,4434.92209563,4698.6362866785,4978.0317395533,5274.0409106059,5587.6517029281,5919.9107633862,6271.926975708,6644.8751612791,7040,7458.6201842894,7902.132820098,8372.0180896192,8869.8441912599,9397.272573357,9956.0634791066,10548.081821211,11175.303405856,11839.821526772,12543.853951416]);class brcWindow extends PIXI.NineSlicePlane{constructor(size){super(PIXI.Loader.shared.resources.sprites.spritesheet.textures["window.png"],7,7,7,7),size=size||{x:17,y:22},this.width=size.x,this.height=size.y,this.pivot.x=.5*this.width,this.pivot.y=.5*this.height;var dummyTex=new PIXI.NineSlicePlane(PIXI.Loader.shared.resources.sprites.textures["dummy-texture.png"],0,0,0,0);this.xButton=new brcButton("x",void 0,{x:1,y:0},void 0,dummyTex,dummyTex),this.xButton.position.set(size.x-2,0),this.xButton.onClick=()=>{this.visible=!1},this.addChild(this.xButton),this.interactive=!0}get dimensions(){return{x:this.background.width,y:this.background.height}}set dimensions(value){this.background.width=value.x,this.background.height=value.y}}class brcButton extends PIXI.Container{constructor(text,size,anchor,tooltip,upTexture,downTexture){super(),anchor=anchor||{x:0,y:0},text=text||"";var textBmp=new PIXI.BitmapText(text,{font:"8px pixelmix",align:"center"});this.text=text,this.foreground=textBmp;var nsp=upTexture||new PIXI.NineSlicePlane(PIXI.Loader.shared.resources.sprites.spritesheet.textures["button.png"],3,3,3,3);size=size||{x:textBmp.width+7,y:textBmp.height+7},nsp.width=size.x,nsp.height=size.y,this.foreground.pivot.set(textBmp.width/2,textBmp.height/2),this.foreground.position.set(nsp.width/2,nsp.height/2-2),this.background=nsp;var clicked=downTexture||new PIXI.NineSlicePlane(PIXI.Loader.shared.resources.sprites.spritesheet.textures["button-clicked.png"],3,3,3,3);function onDown(event){this.background.visible=!1,this.clicked.visible=!0,this.foreground.x-=1,this.foreground.y+=1}function onUp(event){this.background.visible=!0,this.clicked.visible=!1,this.foreground.x+=1,this.foreground.y-=1,this.onClick(),this.isToggle&&(this.onOff=!this.onOff,this.onOff?this.foreground.tint=10547314:this.foreground.tint=16777215,this.onToggle(this.onOff))}function cancel(){this.background.visible=!0,this.clicked.visible=!1,this.foreground.x+=1,this.foreground.y-=1}clicked.width=size.x,clicked.height=size.y,clicked.visible=!1,this.clicked=clicked,this.addChild(this.background),this.addChild(this.clicked),this.addChild(this.foreground),this.pivot.x=nsp.width*anchor.x,this.pivot.y=nsp.height*anchor.y,this.onClick=()=>{},this.interactive=!0,this.buttonMode=!0,this.on("mousedown",onDown).on("touchstart",onDown).on("mouseup",onUp).on("mouseupoutside",cancel).on("touchend",onUp).on("touchendoutside",cancel),null!=tooltip&&(this.tooltip=tooltip,this.on("mouseover",TooltipSet.showTooltip).on("mouseout",TooltipSet.hideTooltip)),this.isToggle=!1,this.onOff=!1}set face(sprite){this.removeChild(this.foreground),this.addChild(sprite),this.foreground=sprite}}class TooltipSet extends PIXI.Container{constructor(){super()}create(text,align,anchor){align=align||"left",""==text&&(text="placeholder"),null==anchor&&(anchor={x:0,y:1},"right"==align&&(anchor.x=1));var tooltip=new PIXI.Container;tooltip.text=text;var text=new PIXI.BitmapText(text,{font:"8px pixelmix",align:align});let bg=new PIXI.NineSlicePlane(PIXI.Loader.shared.resources.sprites.spritesheet.textures["tooltip.png"],4,4,4,4);return bg.height=13,bg.width=text.width+8,text.x+=4,text.y+=2,tooltip.set=this,tooltip.addChild(bg),tooltip.addChild(text),tooltip.primaryAnchor=anchor,tooltip.pivot.x=tooltip.width*anchor.x,tooltip.pivot.y=tooltip.height*anchor.y,tooltip.visible=!1,tooltip.cacheAsBitmap=!0,this.addChild(tooltip),tooltip}static showTooltipOnHover(event){this.tooltip.visible=!0,this.tooltip.position=this.position}static showTooltipOnTap(event){this.tooltip.parent.visible&&(this.tooltip.set.previous&&(this.tooltip.set.previous.visible=!1),this.tooltip.pivot.x=0,this.tooltip.pivot.y=0,this.tooltip.position=this.tooltip.parent.toLocal({x:0,y:0}),this.tooltip.visible=!0,this.tooltip.set.previous=this.tooltip,setTimeout(()=>{this.tooltip.visible=!1},2e3))}static hideTooltip(event){this.tooltip.visible=!1}}function createOverlay(){var root=new PIXI.Container;root.buttons=new PIXI.Container,root.buttons.name="Buttons";var transparent=new PIXI.NineSlicePlane(PIXI.Loader.shared.resources.sprites.textures["dummy-texture.png"],0,0,0,0);root.tooltipSet=new TooltipSet,root.addChild(root.tooltipSet),root.tooltipSet.visible=!0,root.buttons.tooltips=new brcButton("?",void 0,{x:1,y:0},void 0,transparent,transparent),root.buttons.tooltips.face=new PIXI.Sprite(PIXI.Loader.shared.resources.sprites.textures["question.png"]),root.buttons.tooltips.isToggle=!0,root.buttons.tooltips.onOff=!1,root.buttons.tooltips.onToggle=onOff=>{controller.tooltipSet.visible=onOff},root.buttons.addChild(root.buttons.tooltips);var text="";if(onMobile)text="hey there you!",iOS&&(text+="\n"),text+="\nbefore you go on ahead, you should really go into fullscreen, it's just nicer don't you think? also, if you're feeling lost, tap the \"?\" icon above.",text+=iOS?"\n\nhave fun!":"\nhave fun!\n\ngo fullscreen?";else{var t="... but it seems your browser doesn't support it :(. ";haveMidi&&(t=", it connects automatically when you plug it in! "),text="hi there! \nbefore you go on ahead, you should know you can also control this synth with a midi controller"+t+'also, if you\'re feeling lost, click the "?" icon above to show tooltips. \nhave fun! '}return root.windows=new PIXI.Container,root.windows.fullscreen=new brcWindow({x:controller.texture.width,y:controller.texture.height+10}),root.windows.fullscreen.text=new PIXI.BitmapText(text,{align:"center",font:"8px pixelmix"}),root.windows.fullscreen.pivot.set(root.windows.fullscreen.width/2,root.windows.fullscreen.height/2),root.windows.fullscreen.text.anchor.set(.5,0),root.windows.fullscreen.text.position.set(root.windows.fullscreen.width/2,10),root.windows.fullscreen.text.maxWidth=220,root.windows.fullscreen.addChild(root.windows.fullscreen.text),root.windows.fullscreen.name="Fullscreen request",root.windows.fullscreen.visible=!0,root.windows.fullscreen.xButton.visible=!1,iOS||root.windows.addChild(root.windows.fullscreen),root.windows.fullscreen.buttonNah=new brcButton("nah...",{x:60,y:18},{x:1,y:1}),root.windows.fullscreen.buttonYeah=new brcButton("yeah!",{x:60,y:18},{x:0,y:1}),root.windows.fullscreen.buttonNah.position.set(root.windows.fullscreen.width/2-3,root.windows.fullscreen.height-6),root.windows.fullscreen.buttonYeah.position.set(root.windows.fullscreen.width/2+3,root.windows.fullscreen.height-6),root.windows.fullscreen.buttonNah.onClick=()=>{audioEngine.start(),root.windows.fullscreen.visible=!1},root.windows.fullscreen.buttonYeah.onClick=()=>{audioEngine.start();var canvas=document.getElementById("pixicanvas"),req;iOS||(canvas.requestFullScreen||canvas.webkitRequestFullScreen||canvas.mozRequestFullScreen).call(canvas);root.windows.fullscreen.visible=!1},root.windows.fullscreen.buttonLetsgo=new brcButton("let's go!",{x:100,y:18},{x:.5,y:1}),root.windows.fullscreen.buttonLetsgo.position.set(root.windows.fullscreen.width/2,root.windows.fullscreen.height-6),root.windows.fullscreen.buttonLetsgo.onClick=()=>{audioEngine.start(),root.windows.fullscreen.visible=!1},onMobile&&!iOS?(root.windows.fullscreen.addChild(root.windows.fullscreen.buttonNah),root.windows.fullscreen.addChild(root.windows.fullscreen.buttonYeah)):root.windows.fullscreen.addChild(root.windows.fullscreen.buttonLetsgo),root.addChild(root.windows),root.addChild(root.buttons),root}var noteRange=[48,72],currentOctave=4;class Controller extends PIXI.Sprite{constructor(anchorX,anchorY){var spritesheet=PIXI.Loader.shared.resources.sprites.spritesheet;function setupKeys(controller){var keyBindings,keyboard=new brcKeyboard([["a","A"],["w","W"],["s","S"],["e","E"],["d","D"],["f","F"],["t","T"],["g","G"],["y","Y"],["h","H"],["u","U"],["j","J"],["k","K"],["o"],["l"],["p"],[";"],[],[],[],[],[],[],[],[]],controller);return keyboard.position.set(35,54),controller.keyboard=keyboard,keyboard}function setupSine(controller){let frames=[],str="";for(let i=0;i<30;i++)str=i,i<10&&(str="0"+str),frames.push(controller.spritesheet.textures[str+".png"]);let sineAnimation=new PIXI.AnimatedSprite(frames);return sineAnimation.animationSpeed=.5,sineAnimation.x=192,sineAnimation.y=22,sineAnimation.play(),sineAnimation.name="Sine Animation",sineAnimation}function setupKnobs(tooltipSet){var textureSet=[],sTex=spritesheet.textures["straight-knob.png"],dTex=spritesheet.textures["diagonal-knob.png"];textureSet.push(sTex),textureSet.push(dTex);for(var rotate=6;rotate>0;rotate-=2){let t1=new PIXI.Texture(sTex,sTex.frame,sTex.orig,void 0,rotate),t2=new PIXI.Texture(dTex,dTex.frame,dTex.orig,void 0,rotate);textureSet.push(t1),textureSet.push(t2)}const x=[0,15,30,45,60,75,5,20,35,50,65,80],y=[0,0,0,0,0,0,13,13,13,13,13,13],tooltips=["attack A","sustain A","decay A","release A","gain A","gain B","shape A","shape B","attack B","sustain B","decay B","release B"],initialValues=[2,7,4,3,7,3,1,3,1,1,5,4],types=[8,8,8,8,8,8,4,4,8,8,8,8];let callbacks=[function(v){audioEngine.envelopeA.attack=v},function(v){audioEngine.envelopeA.sustain=remap(v,[0,7],[0,.5])},function(v){audioEngine.envelopeA.decay=remap(v,[0,7],[0,1])},function(v){audioEngine.envelopeA.release=v},function(v){audioEngine.oscillatorA.gain=remap(v,[0,7],[0,1])},function(v){audioEngine.oscillatorB.gain=remap(v,[0,7],[0,1])},function(v){audioEngine.oscillatorB.shape=v},function(v){audioEngine.oscillatorA.shape=v},function(v){audioEngine.envelopeB.attack=v},function(v){audioEngine.envelopeB.sustain=remap(v,[0,7],[0,.5])},function(v){audioEngine.envelopeB.decay=remap(v,[0,7],[0,1])},function(v){audioEngine.envelopeB.release=v}],knobs=new PIXI.Container;knobs.name="Knobs";for(let i=0;i<12;i++){let knob=new brcKnob(textureSet,x[i]+12,y[i]+27,tooltips[i],tooltipSet.create(tooltips[i],"left"),initialValues[i],types[i],callbacks[i]);knobs.addChild(knob)}return knobs}function setupSliders(tooltipSet){const x=[110,118,126,134,142,150,158,166,174,182],initialValues=[0,9,2,9,1,6,1,3,8,7],tooltips=["detune B","lowpass filter","highpass filter","LFO frequency","LFO amplitude","delay time","delay feedback","reverb resonance","reverb dampening","reverb wet/dry"];let callbacks=[function(v){audioEngine.oscillatorB.shift=v},function(v){audioEngine.lowpass.frequency=v},function(v){audioEngine.highpass.frequency=v},function(v){audioEngine.lfo.frequency=v},function(v){audioEngine.lfo.gain=v/10},function(v){audioEngine.delay.time=v/20},function(v){audioEngine.delay.feedback=v/10},function(v){audioEngine.reverb.resonance=v},function(v){audioEngine.reverb.dampening=v},function(v){audioEngine.reverb.wet=v/10}],sliders=new PIXI.Container;sliders.name="Sliders";for(let i=0;i<x.length;i++){let slider=new brcSlider(x[i],initialValues[i],tooltips[i],tooltipSet.create(tooltips[i],"right"),callbacks[i]);sliders.addChild(slider)}return sliders}function setupOctaveButtons(controller){let octaveButtons=new PIXI.Container;octaveButtons.name="Octave Buttons";var octaveDown=new brcOctaveButton("down",5,95,controller,controller.tooltipSet.create("octave-")),octaveUp=new brcOctaveButton("up",18,95,controller,controller.tooltipSet.create("octave+"));return octaveUp.other=octaveDown,octaveDown.other=octaveUp,octaveButtons.addChild(octaveUp),octaveButtons.addChild(octaveDown),octaveButtons}function setupWheels(controller){let wheels=new PIXI.Container("wheels");wheels.name="Wheels";var pitchWheel=new brcWheel(5,55,1,"pitchwheel",controller.tooltipSet.create("pitch wheel"),(function(value){audioEngine.oscillatorA.detune=200*(1-value),audioEngine.oscillatorB.detune=200*(1-value)}));pitchWheel.resetOnEnd=!0;var modWheel=new brcWheel(18,55,1,"modwheel",controller.tooltipSet.create("modulation wheel"),(function(value){audioEngine.mod.pan(1-value)}));return wheels.addChild(modWheel),wheels.mod=modWheel,wheels.addChild(pitchWheel),wheels.pitch=pitchWheel,controller.wheels=wheels,wheels}super(spritesheet.textures["base.png"]),this.spritesheet=spritesheet,this._noteStack=[],this.tooltipSet=new TooltipSet,this.tooltipSet.visible=!1,this.addChild(setupSine(this)),this.addChild(setupSliders(this.tooltipSet)),this.addChild(setupKnobs(this.tooltipSet)),this.addChild(setupOctaveButtons(this)),this.addChild(setupWheels(this)),this.addChild(setupKeys(this)),this.addChild(this.tooltipSet),this.pivot.x=Math.floor(anchorX*this.width),this.pivot.y=Math.floor(anchorY*this.height)}press(note){if((this._noteStack.length>0&&this._noteStack.last().pitch!=note.pitch||0==this._noteStack.length)&&this._noteStack.push(note),audioEngine.play(note),note.pitch>=noteRange[0]&&note.pitch<=noteRange[1]){let keyId=note.pitch-noteRange[0];this.keyboard.keyActive(keyId,!0)}}release(note){{let p=-1;for(let i=0;i<this._noteStack.length;i++)if(this._noteStack[i].pitch==note.pitch){p=i;break}-1!=p&&this._noteStack.removeFrom(p)}if(0==this._noteStack.length?audioEngine.release():this.press(this._noteStack.last()),note.pitch>=noteRange[0]&&note.pitch<=noteRange[1]){let keyId=note.pitch-noteRange[0];this.keyboard.keyActive(keyId,!1)}}shiftStack(shiftAmount){if(0==this._noteStack.length)return;for(var e of this._noteStack){if(e.midi)continue;let keyId=e.pitch-noteRange[0];this.keyboard.keyActive(keyId,!1),e.pitch+=12*shiftAmount,keyId=e.pitch-noteRange[0],this.keyboard.keyActive(keyId,!0)}let note=this._noteStack.last();audioEngine.play(note)}static processMIDIMessage(message){var command=message.data[0],pitch=message.data[1],velocity=message.data.length>2?message.data[2]:0;switch(command){case 144:velocity>0?controller.press({pitch:pitch,velocity:velocity,midi:!0}):controller.release({pitch:pitch});break;case 128:controller.release({pitch:pitch});break;case 176:controller.wheels.mod.value=message.data[2]/64;break;case 224:controller.wheels.pitch.value=(1-message.data[2])/64}}}class brcKeyboard extends PIXI.Container{constructor(keyBindings,controller){super(),this.controller=controller;var xOffset=[9,4,9,4,13,9,4,9,4,9,4,13],zIndexs=[0,1,0,1,0,0,1,0,1,0,1,0];this.keys=[],this.map={},this.buttons={};var x=0,y=0;for(let i=0;i<25;i++){let key=new brcKey(x,0,i,this);key.zIndex=zIndexs[i%12];let bind={pressed:!1};for(let j=0;j<keyBindings[i].length;j++)this.buttons[keyBindings[i][j]]=bind,this.map[keyBindings[i][j]]=key;this.keys.push(key),this.addChild(key),x+=xOffset[i%12]}this.sortChildren(),this.downHandler=event=>{if((";"!=event.key||1!=event.getModifierState("CapsLock"))&&event.key in this.buttons&&!this.buttons[event.key].pressed){let k=this.map[event.key].keyId;this.press(k),this.buttons[event.key].pressed=!0,event.preventDefault()}},this.upHandler=event=>{if((";"!=event.key||1!=event.getModifierState("CapsLock"))&&event.key in this.buttons&&this.buttons[event.key].pressed){let k=this.map[event.key].keyId;this.release(k),this.buttons[event.key].pressed=!1,event.preventDefault()}};const downListener=this.downHandler.bind(this),upListener=this.upHandler.bind(this);function onStart(event){var data=event.data;data.dragging=!0;let key=getKey(data.global,this);data.currentKey=key,this.press(key.keyId,data.getLocalPosition(key).y),this.inputs[event.data.identifier]=data}function onEnd(event){null!=this.inputs[event.data.identifier]&&this.inputs[event.data.identifier].dragging&&(this.release(this.inputs[event.data.identifier].currentKey.keyId),this.inputs[event.data.identifier]=null)}function onMove(event){if(!this.inputs[event.data.identifier]||null==this.inputs[event.data.identifier])return;let newKey=getKey(this.inputs[event.data.identifier].global,this);null==newKey?(this.release(this.inputs[event.data.identifier].currentKey.keyId),this.inputs[event.data.identifier]=null):newKey.keyId!=this.inputs[event.data.identifier].currentKey.keyId&&(this.press(newKey.keyId,this.inputs[event.data.identifier].getLocalPosition(newKey).y),this.release(this.inputs[event.data.identifier].currentKey.keyId),this.inputs[event.data.identifier].currentKey=newKey)}function getKey(position,root){return renderer.plugins.interaction.hitTest(position,root)}window.addEventListener("keydown",downListener,!1),window.addEventListener("keyup",upListener,!1),this.caps=keybind("CapsLock"),this.caps.isOn=!1,this.caps.press=()=>{this.caps.isOn=!this.caps.isOn;let shift=this.caps.isOn?1:-1;this.shift.isDown||controller.shiftStack(shift)},this.shift=keybind("Shift"),this.shift.press=()=>{this.caps.isOn||controller.shiftStack(1)},this.shift.release=()=>{this.caps.isOn||controller.shiftStack(-1)},this.inputs=[],this.interactive=!0,this.buttonMode=!0,this.interactiveChildren=!0,this.dragging=!1,this.on("mousedown",onStart).on("touchstart",onStart).on("mouseup",onEnd).on("mouseupoutside",onEnd).on("touchend",onEnd).on("touchendoutside",onEnd).on("touchmove",onMove).on("mousemove",onMove)}release(keyId){let pitch=keyId+noteRange[0];(this.shift.isDown||this.caps.isOn)&&(pitch+=12),this.controller.release({pitch:pitch})}press(keyId,y){var key=this.keys[keyId];y=y||3*key.height/4;let pitch=key.keyId+noteRange[0];(this.shift.isDown||this.caps.isOn)&&(pitch+=12);let velocity=Math.floor(remap(y,[0,key.height],[0,127]));this.controller.press({pitch:pitch,velocity:velocity})}keyActive(keyId,active){let keySprite=this.keys[keyId],str=active?"-on.png":".png";null!=keySprite&&(keySprite.texture=controller.spritesheet.textures[KEY_TYPES[keyId]+str])}}class brcComponent extends PIXI.Sprite{constructor(texture,x,y,px,py,name,maxValue,initialValue,tooltip,callbackFunc){super(texture),this.x=x,this.y=y,this.pivot.x=px,this.pivot.y=py,this.callbackFunc=callbackFunc,this.name=name,this.maxValue=maxValue,this.value=initialValue,tooltip&&(this.tooltip=tooltip,onMobile?this.on("touchstart",TooltipSet.showTooltipOnTap):this.on("mouseover",TooltipSet.showTooltipOnHover).on("mouseout",TooltipSet.hideTooltip))}set value(value){this._value=value,this.callbackFunc(value)}get value(){return this._value}}class brcKey extends brcComponent{constructor(x,y,keyId,tooltip){var name="key"+keyId,tex;super(PIXI.Loader.shared.resources.sprites.spritesheet.textures[KEY_TYPES[keyId]+".png"],x,y,0,0,name,0,0,void 0,()=>{}),this.keyId=keyId,this.interactive=!0}}class brcOctaveButton extends brcComponent{constructor(type,x,y,controller,tooltip){var textures=PIXI.Loader.shared.resources.sprites.spritesheet.textures,texture;super(textures["button-"+type+".png"],x,y,0,0,"octave"+type,0,0,tooltip,()=>{}),this.type=type,this.controller=controller,this.textures=textures,this.callbackFunc="up"==type?up:down,this.interactive=!0,this.buttonMode=!0,this.on("mousedown",this.callbackFunc).on("touchstart",this.callbackFunc);let key="up"==type?"x":"z";function up(){7!=currentOctave&&(currentOctave++,noteRange[0]+=12,noteRange[1]+=12,this.controller.shiftStack(1),this.updateTexture(),this.other.updateTexture())}function down(){1!=currentOctave&&(currentOctave--,noteRange[0]-=12,noteRange[1]-=12,this.controller.shiftStack(-1),this.updateTexture(),this.other.updateTexture())}this.keyButtonL=keybind(key),this.keyButtonL.press=()=>{this.callbackFunc()},this.keyButtonU=keybind(key.toUpperCase()),this.keyButtonU.press=()=>{this.callbackFunc()}}updateTexture(){let t=-1,shift=0;"down"==this.type?(t=4-currentOctave,shift=4):"up"==this.type&&(t=currentOctave-4),t>=0&&(this.texture=this.textures[BUTTON_TYPE[t+shift]])}}class brcSlider extends brcComponent{constructor(x,initialValue,name,tooltip,callbackFunc){let y=SLIDER_RANGE[1]-2*initialValue;function onDragStart(event){this.eventData=event.data,this.dragging=!0}function onDragEnd(event){this.eventData=null,this.dragging=!1}function onDragMove(event){if(this.dragging){var newPosition=this.eventData.getLocalPosition(this.parent);if(newPosition.y>SLIDER_RANGE[0]&&newPosition.y<=SLIDER_RANGE[1]){let y=round(newPosition.y,2)+1;this.value=(SLIDER_RANGE[1]-y)/2,this.position.y=y}}}super(PIXI.Loader.shared.resources.sprites.spritesheet.textures["slider.png"],x,y,3,3,name,10,initialValue,tooltip,callbackFunc),this.on("mousedown",onDragStart).on("touchstart",onDragStart).on("mouseup",onDragEnd).on("touchend",onDragEnd).on("mousemove",onDragMove).on("touchmove",onDragMove).on("mouseupoutside",onDragEnd).on("touchendoutside",onDragEnd),this.buttonMode=!0,this.interactive=!0}set value(value){value>=0&&value<=this.maxValue&&(this._value=value,this.callbackFunc(value))}get value(){return this._value}}class brcKnob extends brcComponent{constructor(textures,x,y,name,tooltip,initialValue,type,callbackFunc){if(4!=type&&8!=type)return;let tex;function onClick(event){this.value++}function onDragStart(event){this.eventData=event.data,this.eventData.startingValue=this.value,this.dragging=!0}function onDragEnd(event){this.eventData=null,this.dragging=!1}function onDragMove(event){if(this.dragging){var newPosition;let delta=-round(this.eventData.getLocalPosition(this).y,8)/8;0==delta&&this.value++;var newValue=this.eventData.startingValue+delta;newValue=Math.max(0,newValue),newValue=Math.min(newValue,7),this.value=newValue}}tex=4==type?textures[2*initialValue]:textures[initialValue],super(tex,x,y,4,4,name,type-1,initialValue,tooltip,callbackFunc),this._type=type,this.textures=textures,this.value=initialValue,this.on("click",onClick).on("tap",onClick).on("mousedown",onDragStart).on("touchstart",onDragStart).on("mouseup",onDragEnd).on("touchend",onDragEnd).on("mousemove",onDragMove).on("touchmove",onDragMove).on("mouseupoutside",onDragEnd).on("touchendoutside",onDragEnd),this.buttonMode=!0,this.interactive=!0}set value(value){value%=this.maxValue+1,this._value=value,this.texture=brcKnob.matchTexture(value,this._type,this.textures),this.callbackFunc(this._value)}get value(){return this._value}static matchTexture(value,type,textures){if(null!=textures)return 4==type&&(value*=2),textures[value]}}class brcWheel extends brcComponent{constructor(x,y,initialValue,name,tooltip,callbackFunc){var texture;function onDragStart(event){this.eventData=event.data,this.dragging=!0,this.value=this.valueFrom(this.eventData.getLocalPosition(this))}function onDragEnd(event){this.eventData=void 0,this.dragging=!1,this.resetOnEnd&&(this.value=1)}function onDragMove(event){if(this.dragging){let pos=this.eventData.getLocalPosition(this);this.value=this.valueFrom(pos)}}super(PIXI.Loader.shared.resources.sprites.spritesheet.textures["touch-wheel.png"],x,y,0,0,name,2,initialValue,tooltip,callbackFunc),this.yRange=[2,36],this.on("mousedown",onDragStart).on("touchstart",onDragStart).on("mouseup",onDragEnd).on("mouseupoutside",onDragEnd).on("touchend",onDragEnd).on("touchendoutside",onDragEnd).on("mousemove",onDragMove).on("touchmove",onDragMove),this.buttonMode=!0,this.interactive=!0,this.resetOnEnd=!1}valueFrom(position){let value=Math.floor(position.y);return value<this.yRange[0]?value=this.yRange[0]:value>this.yRange[1]&&(value=this.yRange[1]),remap(value,this.yRange,[0,2])}}const SHIFT_CURVE=[-1200,-1100,-700,-400,-300,0,300,400,700,1100,1200],LOWPASS_CURVE=[150,400,700,1200,3e3,3500,4e3,5e3,6e3,7e3,1e4],HIGHPASS_CURVE=[50,150,250,450,650,800,1e3,1200,1500,2e3,3e3],DAMPENING_CURVE=[100,300,600,1e3,2e3,4e3,6500,8e3,1e4,14e3,19e3],RELEASE_CURVE=[0,.1,.2,.3,.6,1,1.5,2.5],ATTACK_CURVE=[0,.02,.05,.1,.3,.5,.8,1.2],COMB_FILTER_TUNINGS=[1557,1617,1491,1422,1277,1356,1188,1116].map(dps=>dps/44100),ALLPASS_FREQUENCES=[225,556,441,341],DEFAULT_VOLUME=.8;class AudioEngine{constructor(){var AudioContext=window.AudioContext||window.webkitAudioContext;this.started=!1,this.audioContext=new AudioContext,this._noteOn=!1,this.velocity=!0,this.resetEnvelope=!0,this.slideSpeed=.1,this._gainM=this.audioContext.createGain(),this.oscillatorA=new Oscillator(this.audioContext),this.oscillatorB=new Oscillator(this.audioContext),this.envelopeA=new Envelope(this.audioContext),this.envelopeB=new Envelope(this.audioContext),this.lowpass=new Filter(this.audioContext,"lowpass"),this.highpass=new Filter(this.audioContext,"highpass"),this.lfo=new LFO(this.audioContext),this.mod=new GainPan(this.audioContext),this.delay=new Delay(this.audioContext),this.reverb=new Freeverb(this.audioContext),this.oscillatorA.node.connect(this.mod.left),this.mod.left.connect(this.envelopeA.node),this.envelopeA.node.connect(this.lowpass.node),this.oscillatorB.node.connect(this.mod.right),this.mod.right.connect(this.envelopeB.node),this.envelopeB.node.connect(this.lowpass.node),this.lowpass.node.connect(this.highpass.node),this.highpass.node.connect(this.lfo.node),this.lfo.node.connect(this.delay.input),this.delay.output.connect(this.reverb.input),this.reverb.output.connect(this._gainM),this._gainM.connect(this.audioContext.destination),iOS&&this.start()}start(){this.started?console.log("AUDIOENGINE STARTED TWICE!"):(this.started=!0,"suspended"===this.audioContext.state&&this.audioContext.resume(),this._gainM.gain.value=1,this.lfo.start(0),this.oscillatorA.start(0),this.oscillatorB.start(0))}play(note){"suspended"===this.audioContext.state&&this.audioContext.resume();let volume=remap(note.velocity,[0,127],[0,1]),pitch=note.pitch;this._noteOn?(this.resetEnvelope&&(this.envelopeA.reset(0),this.envelopeB.reset(0),this.envelopeA.start(0),this.envelopeB.start(0)),this.oscillatorA.slideTo(frequency(pitch),this.slideSpeed),this.oscillatorB.slideTo(frequency(pitch),this.slideSpeed)):(this.envelopeA.reset(0),this.envelopeB.reset(0),0==this.velocity&&(volume=.8),this.oscillatorA.frequency=frequency(pitch),this.oscillatorB.frequency=frequency(pitch),this._gainM.gain.setTargetAtTime(volume,this.audioContext.currentTime,.001),this.envelopeA.start(0),this.envelopeB.start(0),this._noteOn=!0)}release(){"suspended"===this.audioContext.state&&this.audioContext.resume(),this.envelopeA.stop(0),this.envelopeB.stop(0),this._noteOn=!1}}class Oscillator{constructor(audioContext){this._shift=0,this._detune=0,this.audioContext=audioContext,this._oscillator=audioContext.createOscillator(),this.node=audioContext.createGain(),this._oscillator.connect(this.node)}set shape(value){let type="";switch(value){case 0:type="sine";break;case 1:type="square";break;case 2:type="sawtooth";break;case 3:type="triangle";break;default:type="sine"}this._oscillator.type=type}get frequency(){return this._oscillator.frequency.value}set frequency(value){this._oscillator.frequency.setTargetAtTime(value,this.audioContext.currentTime,.001)}slideTo(value,delay){delay=delay||3e-4,this._oscillator.frequency.setTargetAtTime(value,this.audioContext.currentTime+delay,.3*delay)}get gain(){return this.node.gain.value}set gain(value){this.node.gain.setTargetAtTime(value,this.audioContext.currentTime,.001)}get shift(){return this._shift}set shift(value){this._shift=SHIFT_CURVE[value],this._oscillator.detune.setTargetAtTime(this._shift+this._detune,this.audioContext.currentTime,.001)}get detune(){return this._detune}set detune(value){this._detune=value,this._oscillator.detune.setTargetAtTime(this._shift+this._detune,this.audioContext.currentTime,.001)}start(value){this._oscillator.start(value)}stop(value){this._oscillator.stop(value)}}class Freeverb{constructor(audioContext){this.audioContext=audioContext,this.input=audioContext.createGain(),this.output=audioContext.createGain(),this._dry=audioContext.createGain(),this._wet=audioContext.createGain(),this._merger=audioContext.createChannelMerger(2),this._doubler={},this._doubler.left=audioContext.createGain(),this._doubler.right=audioContext.createGain(),this._wet.gain.value=.6,this._dry.gain.value=.4,this.input.connect(this._wet),this._wet.connect(this._doubler.left),this._wet.connect(this._doubler.right),this.input.connect(this._dry),this._dry.connect(this.output),this._combFilters=COMB_FILTER_TUNINGS.map(delay=>new CombFilter(audioContext,delay));const combsLeft=this._combFilters.slice(0,4),combsRight=this._combFilters.slice(4);for(var frequency of(this._allPassFilters=[],ALLPASS_FREQUENCES)){var allpass=audioContext.createBiquadFilter();allpass.type="allpass",allpass.frequency.value=frequency,this._allPassFilters.push(allpass)}combsLeft.forEach(combFilter=>{this._doubler.left.connect(combFilter.input),combFilter.output.connect(this._merger,0,0)}),combsRight.forEach(combFilter=>{this._doubler.right.connect(combFilter.input),combFilter.output.connect(this._merger,0,1)}),this._merger.connect(this._allPassFilters[0]),this._allPassFilters[0].connect(this._allPassFilters[1]),this._allPassFilters[1].connect(this._allPassFilters[2]),this._allPassFilters[2].connect(this._allPassFilters[3]),this._allPassFilters[3].connect(this.output)}get wet(){return this._wet.gain.value}set wet(value){this._wet.gain.setTargetAtTime(value,this.audioContext.currentTime,.001),this._dry.gain.setTargetAtTime((1-value)/2,this.audioContext.currentTime,.001)}get resonance(){return this._combFilters[0].resonance}set resonance(value){for(var combFilter of this._combFilters)combFilter.resonance=value}get dampening(){return this._combFilters[0].dampening}set dampening(value){for(var combFilter of this._combFilters)combFilter.dampening=value}}class CombFilter{constructor(audioContext,delay){this.audioContext=audioContext,this.input=audioContext.createGain(),this.output=audioContext.createGain(),this._lowPass=audioContext.createBiquadFilter(),this._delay=audioContext.createDelay(),this._gain=audioContext.createGain(),this._lowPass.type="lowpass",this._lowPass.frequency.value=440,this._delay.delayTime.value=delay,this._gain.gain.value=.5,this.input.connect(this._delay),this._delay.connect(this._lowPass),this._lowPass.connect(this._gain),this._gain.connect(this._delay),this._gain.connect(this.output)}get resonance(){return this._gain.gain.value}set resonance(value){value=remap(value,[0,10],[0,.75]),this._gain.gain.setTargetAtTime(value,this.audioContext.currentTime,.001)}get dampening(){return this._lowPass.frequency.value}set dampening(value){value=DAMPENING_CURVE[value],this._lowPass.frequency.setTargetAtTime(value,this.audioContext.currentTime,.001)}}class LFO extends Oscillator{constructor(audioContext){super(audioContext),this._oscillator.disconnect(this.node),this._constant=audioContext.createConstantSource(),this._gain=audioContext.createGain(),this._oscillator.connect(this._gain),this._constant.connect(this._gain),this._gain.connect(this.node.gain)}get frequency(){return this._oscillator.frequency.value}set frequency(value){value=value*value/5,this._oscillator.frequency.setTargetAtTime(value,this.audioContext.currentTime,.001)}get gain(){return this._gain.value}set gain(value){this._gain.gain.setTargetAtTime(value,this.audioContext.currentTime,.001),value=(1-value)/2,this._constant.offset.setTargetAtTime(value,this.audioContext.currentTime,.001)}}class Filter{constructor(audioContext,type){this.audioContext=audioContext,this.setValue=0,this.node=audioContext.createBiquadFilter(),this.node.type=type}get frequency(){return this.node.frequency.value}set frequency(value){"lowpass"==this.node.type?value=LOWPASS_CURVE[value]:"highpass"==this.node.type&&(value=HIGHPASS_CURVE[value]),this.setValue=value,this.node.frequency.setTargetAtTime(value,this.audioContext.currentTime,.001)}get q(){return this.node.Q.value}set q(value){value=remap(value,[0,10],[.25,5]),this.node.Q.setTargetAtTime(value,this.audioContext.currentTime,.001)}}class Envelope{constructor(audioContext){this._open=!1,this._sustain=0,this._attack=0,this._release=0,this.decay=0,this.audioContext=audioContext,this.node=audioContext.createGain(),this.node.gain.value=0}start(delay){this._open=!0;let dt=delay+this._attack;this.node.gain.linearRampToValueAtTime(.5,this.audioContext.currentTime+dt),dt+=this.decay,this.node.gain.linearRampToValueAtTime(this._sustain,this.audioContext.currentTime+dt)}stop(delay){this._open=!1,this.reset(0);let dt=delay+this._release;this.node.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+dt)}reset(delay){this.node.gain.cancelScheduledValues(delay)}get sustain(){return this._sustain}set sustain(value){this._sustain=value,this._open&&this.node.gain.setTargetAtTime(this._sustain,this.audioContext.currentTime,.001)}get attack(){return this._attack}set attack(value){this._attack=ATTACK_CURVE[value]}get release(){return this._release}set release(value){this._release=RELEASE_CURVE[value]}}class Delay{constructor(audioContext){this.audioContext=audioContext,this.input=audioContext.createGain(),this._delay=audioContext.createDelay(),this._feedback=audioContext.createGain(),this.output=audioContext.createGain(),this.input.connect(this._feedback),this._delay.connect(this._feedback),this._feedback.connect(this._delay),this._delay.connect(this.output),this.input.connect(this.output)}get time(){return this._delay.delayTime.value}set time(value){this._delay.delayTime.setTargetAtTime(value,this.audioContext.currentTime,.001)}get feedback(){return this._feedback.gain.value}set feedback(value){this._feedback.gain.setTargetAtTime(value,this.audioContext.currentTime,.001)}}class GainPan{constructor(audioContext){this.audioContext=audioContext,this.left=audioContext.createGain(),this.right=audioContext.createGain()}pan(value){let right=1+value,left=1-value;this.left.gain.setTargetAtTime(left,this.audioContext.currentTime,.001),this.right.gain.setTargetAtTime(right,this.audioContext.currentTime,.001)}}const DEBUG=!1;var haveMidi=!1,scaleModifier=0,onMobile,iOS,audioEngine,controller,renderer,stage;function main(){PIXI.settings.SCALE_MODE=PIXI.SCALE_MODES.NEAREST,PIXI.settings.ROUND_PIXELS=!0,renderer=new PIXI.Renderer({view:pixicanvas,backgroundColor:2584187}),stage=new PIXI.Container;const ticker=PIXI.Ticker.shared,loader=PIXI.Loader.shared;try{function onMIDIFailure(){console.log("MIDI Not Supported")}function onMIDISuccess(midiAccess){for(var input of(haveMidi=!0,midiAccess.inputs.values()))input.onmidimessage=Controller.processMIDIMessage;midiAccess.onstatechange=e=>{e.port.onmidimessage=Controller.processMIDIMessage}}navigator.requestMIDIAccess().then(onMIDISuccess,onMIDIFailure)}catch(error){}var t;onMobile=isMobile(),iOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,(!!navigator.platform&&/iPad|iPhone|iPod/.test(navigator.platform))!=iOS&&console.log("Confusion ensues! Two tests for iOS give two different results");var sekaiButton={ref:document.getElementById("sekai"),rescale:function(scale){let w=16*scale,h=w/2;this.ref.style.width=w.toString()+"px",this.ref.style.height=h.toString()+"px"}};function setup(){audioEngine=new AudioEngine,controller=new Controller(.5,.5);var overlay=createOverlay(),scaleUp,scaleUp;function sizeRenderer(){vh=.01*window.innerHeight,document.documentElement.style.setProperty("--vh",`${vh}px`),size={width:pixicanvas.clientWidth,height:pixicanvas.clientHeight},pixicanvas.width=size.width*devicePixelRatio,pixicanvas.height=size.height*devicePixelRatio,renderer.resize(size.width,size.height);let aspect=size.width>size.height?"landscape":"portrait",w,h,scale;"landscape"==aspect?(w=Math.floor((size.width-5)/controller.texture.width),h=Math.floor((size.height-5)/controller.texture.height)):(w=Math.floor((size.height-5)/controller.texture.width),h=Math.floor((size.width-5)/controller.texture.height)),scale=Math.min(w,h),scale+=scaleModifier,0==scale&&alert("Where did you find a screen this small? Sorry, content won't fit!"),controller.scale.set(scale),overlay.scale.set(scale),sekaiButton.rescale(scale),controller.position.set(renderer.screen.width/2,renderer.screen.height/2),overlay.position.set(renderer.screen.width/2,renderer.screen.height/2),"portrait"==aspect?(controller.angle=90,overlay.angle=90,overlay.buttons.position.set(renderer.screen.height/(2*scale),-renderer.screen.width/(2*scale)+2)):(controller.angle=0,overlay.angle=0,overlay.buttons.position.set(renderer.screen.width/(2*scale),-renderer.screen.height/(2*scale)+2))}(scaleUp=keybind("=")).press=event=>{event.getModifierState("Control")&&(scaleModifier++,sizeRenderer())},(scaleUp=keybind("-")).press=event=>{event.getModifierState("Control")&&(scaleModifier--,sizeRenderer())},window.addEventListener("resize",sizeRenderer),sizeRenderer(),stage.addChild(controller),stage.addChild(overlay),ticker.maxFPS=30,ticker.add(()=>{renderer.render(stage)}),ticker.start()}loader.add("tooltipFont","img/pixelmix.fnt").add("sprites","img/spritesheet.json").load(setup)}